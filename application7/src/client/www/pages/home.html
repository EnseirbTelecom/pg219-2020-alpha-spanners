<template>
  <div class="page" data-name="home" style="height: 100%;display: flex;flex-direction: column;">
    <div class="toolbar tabbar toolbar-bottom">
      <div class="toolbar-inner">
        <a  class="link" @click="activatePosition">
          <i class="icon material-icons if-md"> add_location</i>
          <span>Activate</span>
        </a>
        <a  class="link"  @click='positionInMap'>
          
          <i class="icon material-icons if-md"> map</i>
          <span>On map</span>
      </a>
  
  
      </div>
    </div>
    <div id="app">
      <div id = "my-panel" class="panel panel-left panel-cover theme-color panel-init">
        <div class="view">
          <div class="page">
            <div class="navbar">
              <div class="navbar-bg"></div>
              <div class="navbar-inner">
                <div class="title">FriendFinder</div>
              </div>
            </div>
            <div id = "panelcontent" class="page-content" >
              <div class="highlights" @click='monprofil'>
                <div class="username" >
                  {{pseudo}}
                </div>
                <div class="mail">
                  {{mail}}
                </div>
              </div>
              <div class="list">
                <ul class="ul">
                  <li class = 'li'>
                    <a href="#tab3" class="tab-link panel-close" @click='monprofil'>
                      <i class="icon f7-icons if-not-md">house_fill</i>
                      <i class="icon material-icons if-md">home</i>
                      
                      <div class="item-inner">
                        <span class="tabbar-label">Home</span>
                       </div>
                    </a>
                  </li>
                  <li class = 'li'>
                    <a href="#tab1" class="tab-link panel-close" @click='pastposition'>
                      <i class="icon f7-icons if-not-md">square_list_fill</i>
                      <i class="icon material-icons if-md"> person_pin_circle</i>
                      <div class="item-inner">
                      <span class="tabbar-label">Position history</span>
                      </div>
                    </a>
                 </li>
                <li class = 'li'>
                  <a href="#tab2" class="tab-link panel-close" @click='myfriends'>
                    <i class="icon f7-icons if-not-md">gear_alt</i>
                    <i class="icon material-icons if-md">people</i>
                    
                    <div class="item-inner">
                     <span class="tabbar-label">Friends</span>
                    </div>
                  </a>
                </li>
  
  
               </ul>
              <div class="logout">
                <a href="#tab5" class="tab-link panel-close"  @click='disconnect'>
                  <i class="icon f7-icons if-not-md">xmark_circle_fill</i>
                  <i class="icon material-icons if-md">power_settings_new</i>
                  <div class="item-inner">
                    <span class="tabbar-label">log out</span>
                   </div>
                </a>
              </div>
              </div>
            </div>
          </div>
        </div>
      </div>
        
  
      <div class="navbar navbar-small">
        <div class="navbar-bg"></div>
        <div class="navbar-inner">
          <div class="left">
            <a href="#" class="link icon-only panel-open" data-panel="left">
              <i class="icon f7-icons if-not-md">menu</i>
              <i class="icon material-icons if-md">menu</i>
            </a>
          </div>
         
          <div class="title-small">
            <div class="title-small-text">FriendFinder</div>
          </div>
          <div class="right">
            <a href="#tab4" class="tab-link panel-close" @click='notification'>
              <i class="icon f7-icons if-not-md">bell<!--span class="badge bg-red">{{nbNotifs}}</span--></i> 
              <i class="icon material-icons if-md">notifications<span class="badge bg-red">{{nbNotifs}}</span></i>
         
            </a>
          </div>
        </div>
      </div>
    </div>
    <div id="mapfriend" style="min-height: 50%; flex:none"> </div>
    <div class="page-content" style="flex:auto; overflow-y:scroll">
      <div class="block-title">Friends' position</div>
      
      <div class="list media-list no-hairlines-between" >
        <ul>
          {{#each friendsPosition}}
          <li class="accordion-item">
            <button href="#" id="{{@index}}" class="item-link item-content segmented-strong" @click="selectPosition('{{@index}}')">
            <div class="item-inner">
              <div class="item-title-row">
                <div class="item-title">{{pseudo}} </div>
                <div class="item-after">{{dateFormat dateArrival}} => </div>
              </div>
              <!-- <div class="item-subtitle">is currently at ({{latitude}} {{longitude}})</div> -->
              <div class="accordion-item-content">        
                <div >Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla sagittis tellus ut turpis condimentum, ut dignissim lacus tincidunt. Cras dolor metus, ultrices condimentum sodales sit amet, pharetra sodales eros. Phasellus vel felis tellus. Mauris rutrum ligula nec dapibus feugiat. In vel dui laoreet, commodo augue id, pulvinar lacus.</div>
              </div>
            </div>
            </button>
            <hr style="height:0px ;border-width:1px;border-color:#d3d3d333 ; color: #d3d3d333; background-color:#d3d3d333">
          </li>
          {{/each}}
        </ul>
      </div>
    </div>

    <input id="clipStorage" type="text" style="height:12px; flex:none">"> <!-- a hidden input area, purpose : set desired content into it then copy it to clipboard -->
  </div>
  
  </template>
  <script>
  var notifClip = app.notification.create({
    icon: '<i class="icon f7-icons">doc_on_clipboard</i>',
    title: 'Clipboard',
    titleRightText: 'now',
    subtitle: 'Coordinates were added to your clipboard',
    closeOnClick: true,
    closeTimeout: 2000,
  })
  console.log(notifClip)
  return {
    methods : {
      async data (){
        const list = [0,0,0,0,0,0,0,0,0,0,0,0,00,0,0,0,0,0,0,0,0];
        const friendposition = list.map((i) => {return {pseudo : "test", latitude: Math.random()*20 , longitude:Math.random()*20, dateArrival: (new Date()).toISOString()}})
        
        return { friendsPosition: friendposition, pseudo: "devmode", nbNotifs: 0};
        var friendsPosition = [];
        var friendreq = [];
        var sentReq = [];
        var pseudo;
        pseudo = app.data.user.pseudo;
        var nbNotifs;
        try {
          friendsPosition = await app.methods.tokenHandlingFetch("/pos/friends")
            .then(res => res.json());
          friendreq = await app.methods.tokenHandlingFetch("/friends/received/pending")
            .then(res => res.json());
            sentReq = await app.methods.tokenHandlingFetch( "/friends/sent/accepted")
           .then(res => res.json())
        } catch(err) {
          this.$app.dialog.alert("Error " + err);
          throw err;
        }
        nbNotifs= Object.keys(friendreq).length + Object.keys(sentReq).length;
        return { friendsPosition: friendsPosition, pseudo: pseudo, nbNotifs: nbNotifs};
      },
      obtainPosition : function() {
        app.methods.tokenHandlingFetch( "/pos/current")
          .then(res => res.json())
          .then(res => {
            console.log(res)
            if (res && res.longitude && res.latitude ){
              this.$app.dialog.alert(res.latitude + ' ' + res.longitude)
            } else {
              this.$app.dialog.alert("You must activate you localisation first !")
            }
          })
      },
      positionInMap : function() {
        app.methods.tokenHandlingFetch("/pos/current" )
          .then(res => res.json())
          .then(res => {
            if (res && res.longitude && res.latitude ){
              this.$router.navigate({
                name : 'map',
                params : {latitude : res.latitude, longitude: res.longitude}
              })
            } else {
              this.$app.dialog.alert("You must activate you localisation first !")
            }
          })
      },
      activatePosition : function(){
        this.$router.navigate('/formPosition')
      },
      monprofil : function(){
        this.$router.navigate('/home');
      },
      myfriends : function(){
        this.$router.navigate('/friendlist')
      },
      notification: function(){
        this.$router.navigate('/notif');
      },
      disconnect: function(){
        app.dialog.confirm("Are you sure ?", "Logout", () => this.$router.navigate('/'))
        
      },
      sentRequest:function(){
        this.$router.navigate('/sentRequest')
      },
      addFriend : function(){
        this.$router.navigate('/addfriends')
      },
      pastposition : function(){
        this.$router.navigate('/pastpositions')
      },
      visualizeOnmap : function(lat, long){
        this.$router.navigate({
          name : 'map',
          params : {latitude : lat, longitude: long}
        })
      },
      toclipboardCallback : function(){
        //copy coords to clipboard ---
        const existsTextarea = document.getElementById("clipStorage")
        const curPos = this.friendsPosition[this.curPosIndex]
        existsTextarea.value = "("+String(curPos.latitude)+", "+String(curPos.longitude)+")" ;
        existsTextarea.select();

        try {
          var status = document.execCommand('copy');
          if(!status){
            console.error("Cannot copy text");
          }else{
            console.log("The text is now on the clipboard");
          }
        } catch (err) {
          console.log('Unable to copy.');
        }
        existsTextarea.value ="";
        // ---
        notifClip.open();

      },
      selectPosition: function(index){
        if (this.mapInfoWindow !== undefined){

          this.mapInfoWindow.close()
          this.mapMarkers[this.curPosIndex].setMap(null);

          const oldEls = $$("#"+this.curPosIndex)
          
          oldEls.removeClass("bg-color-white")
          oldEls.off("taphold", this.toclipboardCallback)
          if( this.curPosIndex != index){
            app.accordion.close( oldEls.parent())
          }
          
        }
        this.curPosIndex = index;
        this.mapMarkers[index].setMap(this.map);


        this.map.setCenter({
          lat: this.friendsPosition[index].latitude,
          lng: this.friendsPosition[index].longitude
        });
        
        const els = $$("#"+index)
        els.addClass("bg-color-white")
        els.on("taphold", this.toclipboardCallback )
        
        app.accordion.open( els.parent());
        els.parent()[0].scrollIntoView();

        this.mapInfoWindow = new google.maps.InfoWindow({
          content: this.friendsPosition[index].pseudo
        });
        this.mapInfoWindow.open(this.map,this.mapMarkers[index])
      }
          
    },
    on: {
      pageInit: function(e, page) {
        this.map = new google.maps.Map(document.getElementById('mapfriend'), {
          zoom: 8,
          center: {lat: 0, lng: 0}
        });
        this.mapMarkers = [];
        var clusterMarker = [];
        console.log(this)
        var tmp,tmp2,data;
        for (const [index, pos] of this.friendsPosition.entries()){
          data = {
            position: {lat: pos.latitude, lng: pos.longitude},
            label: pos.pseudo.slice(0,3),
            title: pos.pseudo,
          }
          tmp = new google.maps.Marker(data);
          tmp.addListener('click',() => this.selectPosition(index) )
          clusterMarker.push(tmp)
          this.mapMarkers.push(new google.maps.Marker(data))
          // We make too sets of markers:
          // one managed by cluster, the other popping only when selected (possibly on top the one managed by cluster if it is not clustered)
          //Why ? beacause adding a infoWindow on top of a marker manager by cluster might cause unwanted behaviour
          //if the cluster algorithm remove the marker with the infoWindow from the map, and then we trie to close the infoWindow it won't work. 
          //And we find ourselves with multiple infoWindow open.
        }
        this.map.setCenter({
          lat: this.friendsPosition[0].latitude,
          lng: this.friendsPosition[0].longitude
        });
     
        var markerCluster = new MarkerClusterer(this.map, clusterMarker)


      }
   }
  }
  </script>
  