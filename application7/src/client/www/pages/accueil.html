<template>
<div class="page" data-name="home">
  <div class="appbar">
    <div class="left">
      <a href="#" class="button" @click ='nextppage'>
        <i class="icon icon-back"></i>
        Friends
        <span class="if-not-md">Back</span>
      </a>
    </div>
  </div>

  <!-- Scrollable page content-->
  <div class="page-content">
   
    <div class="block-title">List of users (resp members ?)</div>
      <div class="list links-list">
        <ul>
          {{#each users}}
            <a href="#"><li>{{mail}} {{surname}} {{name}}</li></a>
            <div class="block block-strong row">
              <div class="col"><a class="button convert-form-to-data" href ='#' @click="add('{{surname}}','{{name}}','{{_id}}')" >Add {{name}}</a></div>
            </div>
          {{/each}}
        </ul>
      </div>
    </div>
  </div>
</template>
<script>
return {
    async data() {
      let users = [];
      try {
        users = await fetch("http://localhost:3000/users")
            .then(res => res.json())
      }
      catch(err) {
        this.$app.dialog.alert("Error " + err);
      }

      let friends = [];
      try {
        friends = await fetch("http://localhost:3000/friends")
          .then(response => response.json())
      }
      catch(err){
        this.$app.dialog.alert("Error " + err);
      }
      finally{
        if(friends.length !=0){
          for (var i=0 ; i <friends.length ; i++){
            for(var j =0;j<users.length;j++){
              if(friends[i].receiverId === users[j]._id && friends[i].senderId === this.$route.params.myidd){
                enleve_inscrit=users.splice(j,1)
              }
              else if(friends[i].senderId === users[j]._id && friends[i].receiverId === this.$route.params.myidd){
                enleve_inscrit1=users.splice(j,1)
              }
            }
          }
        }
        for(var j=0;j<users.length;j++){
          if(users[j]._id === this.$route.params.myidd){
            enleve_inscrit1 = users.splice(j,1)
          }
        }
      }
      return { users: users };
     
    //alert(JSON.stringify(friends))
    return { friends: friends };

    },
    methods : {
      add: function(nom,prenom,id) {
          fetch('http://localhost:3000/invite', {
              method: 'POST',
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                senderId        : this.$route.params.myidd,
                senderSurname   : this.$route.params.nomm,
                senderName      : this.$route.params.prenomm,
                receiverSurname : nom,
                receiverName    : prenom,
                receiverId      : id
              })
          })
          .catch(err => this.$app.dialog.alert('Error ' + err))
          .finally(() => {
            this.$app.dialog.alert('Friend request sent to ' + nom + ' ' + prenom)
            this.$router.navigate(
            {
              name:'profil',
              params:{mytoken:this.$route.params.obj , myidd:this.$route.params.monid , nomm:this.$route.params.monnom , prenomm:this.$route.params.monprenom},
            }
      );
          })
      },
      nextppage: function(){
        this.$router.navigate(
          {
            name:'friends',
            params:{tokenn: this.$route.params.mytoken,idd: this.$route.params.myidd,noom: this.$route.params.nomm ,prenoom:this.$route.params.prenomm},
          }
        );
      },
    }
}
</script>