<template>
  <div class="page" data-name="formPosition">
    <div class="appbar">
      <div class="left">
        <a href="#" class="link back">
          <i class="icon icon-back"></i>
          Back
          <span class="if-not-md">Back</span>
        </a>
      </div>
    </div>

    <div class="page-content">
      <div class="block-title">Position form</div>
        <form class="list" id="my-form">
          <ul>

            <li>
              <div class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Latitude</div>
                  <div class="item-input-wrap">
                    <input type="text" name="latitude" id="latitude" placeholder="Your latitude" max=90 min=-90>
                  </div>
                </div>
              </div>
            </li>

            <li>
              <div class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Longitude</div>
                  <div class="item-input-wrap">
                    <input type="text" name="longitude" id="longitude" placeholder="Your longitude" max=90 min=-90>
                  </div>
                </div>
              </div>
            </li>


            <li>
              <div class="item-content item-input">
                <div class="item-inner">
                    <div class="item-title item-label">Date and time of validation</div>
                    <div class="item-input-wrap">
                      <input type="text" placeholder="Select date and time"  readonly="readonly" id="calendar-date-arrival" >
                    </div>
                </div>
              </div>
            </li>

            <li>
              <div class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Date of departure</div>
                  <div class="item-input-wrap">
                    <input type="text" placeholder="Select date and time" readonly="readonly" id="calendar-date-departure" >
                  </div>
                </div>
              </div>
            </li>

            <li>
              <div class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Optional message</div>
                  <div class="item-input-wrap">
                    <input type="text" name="msg" id="msg" placeholder="Optional message" maxlength=140>
                  </div>
                </div>
              </div>
            </li>

          </ul>
        </form>

        <div class="block block-strong row">
           <div class="col"><a class="button convert-form-to-data" href="#" @click ='submit'>Submit</a></div>
        </div>
    </div>
  </div>
</template>
<script>

return{
   mounted() {
    window.navigator.geolocation.getCurrentPosition(function(position) {
        var inputLatitude = document.getElementById('latitude')
        var inputLongitude = document.getElementById('longitude')
        inputLatitude.value = position.coords.latitude
        inputLongitude.value = position.coords.longitude
      },function(error){
          alert("Error in localisation NÂ° " + error.code + " : " + error.message);
      });
        
      // special variable declaration (-> global) because we need those to be visible outside of the mounted function

      calendarArrival = app.calendar.create({
        inputEl: '#calendar-date-arrival',
        timePicker: true,
        value: [new Date()],
        dateFormat: "HH::mm d/mm/yyyy",
        disabled:[
          {to: new Date(Date.now()- 24*60*60*1000)},
          {from:  new Date(Date.now() +7*24*60*60*1000)}
        ],
        on: {
          close: function(calendar){
            const dateArriv = calendar.getValue()[0];
            console.log(dateArriv.valueOf())
            calendarDeparture.disabled = [
              {to: new Date( dateArriv.valueOf()-24*60*60*1000)},
              {from:  new Date( dateArriv.valueOf() +7*24*60*60*1000)}
            ];
            if (dateArriv< new Date()){
              calendar.setValue([new Date()]);
            }
            
            if (calendarDeparture.getValue()[0]<dateArriv){
              calendarDeparture.setValue( [new Date( dateArriv.valueOf() + 60*60*1000)] );  
            }
          }
        
        }
      });
      
    var firstChangeDeparture = true;
    calendarDeparture = app.calendar.create({
      inputEl: '#calendar-date-departure',
      timePicker: true,
      value: [new Date(Date.now() +60*60*1000)],
      dateFormat: "HH::mm d/mm/yyyy",
      disabled:[
        {to: new Date(Date.now()- 24*60*60*1000)},
        {from:  new Date(Date.now() +7*24*60*60*1000)}
      ],
      on: {
        
        close: function(calendar){
          const dateDepart = calendar.getValue()[0];
          if (calendarArrival.getValue()[0]>dateDepart){
            calendar.setValue( [new Date(calendarArrival.getValue()[0].valueOf() + 60*60*1000)]);  
          }
        }
      
      }
    });


    },
  
  methods :{

    submit: function() {
      const msg         = document.getElementById('msg').value;
      const latitude    = document.getElementById('latitude').value;
      const longitude   = document.getElementById('longitude').value;
      app.data.user.lat = latitude;
      app.data.user.lng = longitude;
      app.methods.tokenHandlingFetch("/pos/activate" , {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          latitude : latitude,
          longitude : longitude,
          arrivalTime : calendarArrival.getValue()[0].toISOString(),
          departureTime : calendarDeparture.getValue()[0].toISOString(),
          msg : msg ,
          })
      })
        
        .catch(err => {app.dialog.alert('Error '+ err); throw err;})
        .finally(resp => this.$router.navigate('/home'))
        
    }
  }
}
</script>
