<template>
<div class="page" data-name="pastposition">
  <!-- Appbar -->
  <div class="appbar">
    <div class="left">
      <a class="button" href="/home">
        <i class="icon icon-back"></i>
        Friends
        <span class="if-not-md">Back</span>
      </a>
    </div>
  </div>
  <!-- Scrollable page content-->
  <div class="page-content">
    <div class="block-title">My scheduled positions</div>

    <div class="list links-list">
      <ul>
        {{#each futurePos}}
        <a href="#"><li> ( {{latitude}} ,  {{longitude}}) &nbsp;&nbsp;&nbsp; {{dateFormat arrivalTime}} -> {{dateFormat departureTime}}</li></a>
        <div class="block block-strong row">
          <div class="col"><a class="button convert-form-to-data" href ='#' @click="delete('{{_id}}')">Delete position</a></div>
        </div>
        <div class="block block-strong row">
          <div class="col"><a class="button convert-form-to-data" href ='#' @click="positionOnmap('{{latitude}}','{{longitude}}')">Visualize on a map</a></div>
        </div>
        {{/each}}
      </ul>
    </div>
    <div class="block-title">My past positions</div>

    <div class="list links-list">
      <ul>
        {{#each pastPos}}
        <a href="#"><li> ( {{latitude}} ,  {{longitude}}) &nbsp;&nbsp;&nbsp; {{dateFormat arrivalTime}} -> {{dateFormat departureTime}}</li></a>
        <div class="block block-strong row">
          <div class="col"><a class="button convert-form-to-data" href ='#' @click="delete('{{_id}}')">Delete position</a></div>
        </div>
        <div class="block block-strong row">
          <div class="col"><a class="button convert-form-to-data" href ='#' @click="positionOnmap('{{latitude}}','{{longitude}}')">Visualize on a map</a></div>
        </div>
        {{/each}}
      </ul>
    </div>
  </div>

  <div class="block block-strong row">
      <div class="col"><a class="button convert-form-to-data" href="#" @click='submit'>Return home</a></div>
  </div>

  </div>
</div>
</template>
<script>

return {
  async data (){
    const pPast = app.methods.tokenHandlingFetch("/pos/past" )
      .then(res => res.json());
    const pSched = app.methods.tokenHandlingFetch("/pos/future" )
      .then(res => res.json());
      
    const res =  await Promise.all([pPast, pSched]).catch(err => this.$app.dialog.alert("Error " + err))

    if (res){
      return { pastPos: res[0], futurePos: res[1] };
    } else {
      return { pastPos: [], futurePos: [] };
    }
    
  },
  methods:{
    submit: function(){
      this.$router.navigate('/home');
    },
    delete : function(idposition){
      app.methods.tokenHandlingFetch( "/pos/delete/"  + idposition , { method: "DELETE",})
        .then(resp => {
          app.dialog.alert('This position has been deleted')
          this.$router.navigate('/pastpositions');
        })
        .catch(err => app.dialog.alert('Error ' + err))

    },
    positionOnmap : function(lat,long){
      this.$router.navigate(
        {
          name:'map',
          params: {
            latitude  : lat,
            longitude : long
          },
        });
    }
  }
}
</script>
